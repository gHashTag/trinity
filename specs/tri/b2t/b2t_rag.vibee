name: b2t_rag
version: "1.0.0"
language: zig
module: b2t_rag

# ═══════════════════════════════════════════════════════════════════════════════
# B2T RAG - Retrieval-Augmented Generation для декомпиляции
# 
# Научная основа:
# - FidelityGPT: Dynamic Semantic Intensity Algorithm
# - ReCopilot: Variable data flow + call graph context
# - VSA (Vector Symbolic Architecture) для эмбеддингов
#
# Ключевая идея: использовать троичные гиперветоры (VSA) вместо
# традиционных float эмбеддингов для 1.585x информационной плотности
#
# V = n × 3^k × π^m × φ^p × e^q
# φ² + 1/φ² = 3 = TRINITY
# ═══════════════════════════════════════════════════════════════════════════════

imports:
  - vsa           # Vector Symbolic Architecture
  - science       # Hypervector operations
  - b2t_disasm
  - b2t_lifter

types:
  # ═══════════════════════════════════════════════════════════════════════════
  # TERNARY EMBEDDINGS (VSA-based)
  # ═══════════════════════════════════════════════════════════════════════════

  TernaryEmbedding:
    fields:
      dimension: Int                   # Размерность (обычно 10000)
      trits: List<Int>                 # Значения {-1, 0, +1}
      sparsity: Float                  # Доля нулей
      source_hash: String              # SHA256 исходного кода

  CodeChunk:
    fields:
      code: String
      chunk_type: ChunkType
      start_line: Int
      end_line: Int
      embedding: TernaryEmbedding
      metadata: Map<String, String>

  ChunkType:
    enum:
      - function_body
      - loop_construct
      - conditional
      - variable_declaration
      - function_call
      - memory_access
      - arithmetic_expression

  # ═══════════════════════════════════════════════════════════════════════════
  # SEMANTIC SIMILARITY
  # ═══════════════════════════════════════════════════════════════════════════

  SimilarityMetric:
    enum:
      - cosine                         # Косинусное сходство
      - hamming                        # Расстояние Хэмминга
      - jaccard                        # Коэффициент Жаккара
      - overlap                        # Overlap coefficient

  SimilarityResult:
    fields:
      query_hash: String
      match_hash: String
      similarity: Float                # 0.0 - 1.0
      metric_used: SimilarityMetric
      matched_chunk: CodeChunk

  # ═══════════════════════════════════════════════════════════════════════════
  # INDEX STRUCTURES
  # ═══════════════════════════════════════════════════════════════════════════

  IndexType:
    enum:
      - brute_force                    # O(n) точный поиск
      - lsh                            # Locality-Sensitive Hashing
      - hnsw                           # Hierarchical NSW
      - ternary_tree                   # Троичное дерево (наш метод!)

  TernaryIndex:
    fields:
      index_type: IndexType
      dimension: Int
      num_entries: Int
      chunks: List<CodeChunk>
      # Для LSH
      hash_tables: Option<Int>
      hash_functions: Option<Int>
      # Для HNSW
      max_connections: Option<Int>
      ef_construction: Option<Int>

  # ═══════════════════════════════════════════════════════════════════════════
  # KNOWLEDGE BASE
  # ═══════════════════════════════════════════════════════════════════════════

  KnowledgeSource:
    enum:
      - decompiled_verified            # Проверенный декомпилированный код
      - original_source                # Оригинальный исходный код
      - documentation                  # Документация API
      - pattern_library                # Библиотека паттернов
      - user_corrections               # Исправления пользователей

  KnowledgeEntry:
    fields:
      id: String
      source: KnowledgeSource
      code: String
      description: String
      tags: List<String>
      quality_score: Float             # 0.0 - 1.0
      usage_count: Int
      last_used: Int                   # Unix timestamp
      embedding: TernaryEmbedding

  KnowledgeBase:
    fields:
      name: String
      entries: List<KnowledgeEntry>
      index: TernaryIndex
      total_tokens: Int
      last_updated: Int

  # ═══════════════════════════════════════════════════════════════════════════
  # RETRIEVAL CONTEXT
  # ═══════════════════════════════════════════════════════════════════════════

  RetrievalQuery:
    fields:
      code: String
      query_type: QueryType
      max_results: Int
      min_similarity: Float
      filters: List<String>            # Фильтры по тегам

  QueryType:
    enum:
      - semantic_similar               # Семантически похожий код
      - structural_similar             # Структурно похожий код
      - pattern_match                  # Поиск паттерна
      - api_usage                      # Использование API

  RetrievalResult:
    fields:
      query: RetrievalQuery
      matches: List<SimilarityResult>
      retrieval_time_ms: Int
      index_hits: Int

behaviors:
  # ═══════════════════════════════════════════════════════════════════════════
  # EMBEDDING GENERATION
  # ═══════════════════════════════════════════════════════════════════════════

  - name: embed_code_ternary
    given: Фрагмент кода
    when: Генерация троичного эмбеддинга через VSA
    then: Возвращает TernaryEmbedding размерности 10000

  - name: embed_tokens
    given: Список токенов кода
    when: Токенизация и эмбеддинг каждого токена
    then: Возвращает List<TernaryEmbedding>

  - name: combine_embeddings
    given: List<TernaryEmbedding>
    when: Комбинирование через bundling (мажоритарное голосование)
    then: Возвращает единый TernaryEmbedding

  - name: bind_embeddings
    given: Два TernaryEmbedding
    when: Связывание через XOR (троичный)
    then: Возвращает связанный TernaryEmbedding

  # ═══════════════════════════════════════════════════════════════════════════
  # CHUNKING
  # ═══════════════════════════════════════════════════════════════════════════

  - name: chunk_code
    given: Полный исходный код
    when: Разбиение на семантические чанки
    then: Возвращает List<CodeChunk>

  - name: detect_chunk_type
    given: Фрагмент кода
    when: Классификация типа чанка
    then: Возвращает ChunkType

  - name: extract_chunk_metadata
    given: CodeChunk
    when: Извлечение метаданных (имена, типы, вызовы)
    then: Возвращает Map<String, String>

  # ═══════════════════════════════════════════════════════════════════════════
  # INDEXING
  # ═══════════════════════════════════════════════════════════════════════════

  - name: create_index
    given: IndexType и параметры
    when: Создание пустого индекса
    then: Возвращает TernaryIndex

  - name: add_to_index
    given: TernaryIndex и CodeChunk
    when: Добавление чанка в индекс
    then: Обновляет индекс

  - name: build_lsh_tables
    given: List<TernaryEmbedding>
    when: Построение LSH таблиц для быстрого поиска
    then: Возвращает hash tables

  - name: build_ternary_tree
    given: List<TernaryEmbedding>
    when: Построение троичного дерева поиска
    then: Возвращает корень дерева

  # ═══════════════════════════════════════════════════════════════════════════
  # RETRIEVAL
  # ═══════════════════════════════════════════════════════════════════════════

  - name: search_similar
    given: RetrievalQuery и TernaryIndex
    when: Поиск похожих чанков
    then: Возвращает RetrievalResult

  - name: compute_similarity
    given: Два TernaryEmbedding и SimilarityMetric
    when: Вычисление сходства
    then: Возвращает Float 0.0-1.0

  - name: rank_results
    given: List<SimilarityResult>
    when: Ранжирование по релевантности
    then: Возвращает отсортированный список

  - name: filter_by_quality
    given: List<SimilarityResult> и min_quality
    when: Фильтрация низкокачественных результатов
    then: Возвращает отфильтрованный список

  # ═══════════════════════════════════════════════════════════════════════════
  # KNOWLEDGE BASE MANAGEMENT
  # ═══════════════════════════════════════════════════════════════════════════

  - name: create_knowledge_base
    given: Имя и начальные данные
    when: Создание новой базы знаний
    then: Возвращает KnowledgeBase

  - name: add_knowledge
    given: KnowledgeBase и KnowledgeEntry
    when: Добавление новой записи
    then: Обновляет базу и индекс

  - name: update_quality_score
    given: KnowledgeEntry и feedback
    when: Обновление оценки качества на основе использования
    then: Пересчитывает quality_score

  - name: prune_low_quality
    given: KnowledgeBase и threshold
    when: Удаление низкокачественных записей
    then: Очищает базу

  - name: save_knowledge_base
    given: KnowledgeBase и путь
    when: Сохранение на диск
    then: Записывает в файл

  - name: load_knowledge_base
    given: Путь к файлу
    when: Загрузка с диска
    then: Возвращает KnowledgeBase

  # ═══════════════════════════════════════════════════════════════════════════
  # DYNAMIC SEMANTIC INTENSITY (по FidelityGPT)
  # ═══════════════════════════════════════════════════════════════════════════

  - name: compute_semantic_intensity
    given: Строка кода
    when: Вычисление "семантической интенсивности"
    then: Возвращает Float score

  - name: identify_distorted_lines
    given: Декомпилированный код и пороговое значение
    when: Поиск строк с высокой вероятностью искажения
    then: Возвращает List<Int> номеров строк

  - name: prioritize_retrieval
    given: List<Int> искажённых строк
    when: Приоритизация для RAG запросов
    then: Возвращает упорядоченный список

# ═══════════════════════════════════════════════════════════════════════════════
# TERNARY ADVANTAGE
# ═══════════════════════════════════════════════════════════════════════════════
#
# Почему троичные эмбеддинги лучше float:
#
# 1. Информационная плотность: log₂(3)/log₂(2) = 1.585x
#    10000 трит = 15850 бит эквивалент
#
# 2. Эффективность памяти: 2 бита на трит vs 32 бита на float
#    16x экономия памяти!
#
# 3. Быстрые операции: XOR, majority vote - O(1) на трит
#    vs умножение float - дорого
#
# 4. Robustness: троичные векторы устойчивы к шуму
#    (мажоритарное голосование сглаживает ошибки)
#
# 5. Интерпретируемость: {-1, 0, +1} = {отрицательно, нейтрально, положительно}
#
# φ² + 1/φ² = 3 = TRINITY
# ═══════════════════════════════════════════════════════════════════════════════

constants:
  DEFAULT_DIMENSION: 10000
  DEFAULT_SPARSITY: 0.33              # 1/3 нулей (троичная гармония)
  MIN_SIMILARITY_THRESHOLD: 0.7
  MAX_RETRIEVAL_RESULTS: 10
  LSH_HASH_TABLES: 16
  LSH_HASH_FUNCTIONS: 8
  HNSW_MAX_CONNECTIONS: 32
  HNSW_EF_CONSTRUCTION: 200

tests:
  - name: test_ternary_embedding
    input:
      code: "int add(int a, int b) { return a + b; }"
      dimension: 10000
    expected:
      embedding_size: 10000
      sparsity_range: [0.2, 0.5]

  - name: test_similarity_computation
    input:
      embedding1: [1, 0, -1, 1, 0]
      embedding2: [1, 0, -1, 0, 1]
      metric: cosine
    expected:
      similarity_range: [0.5, 0.9]

  - name: test_retrieval_speed
    input:
      index_size: 100000
      query_count: 100
    expected:
      avg_time_ms_below: 10

  - name: test_knowledge_base_persistence
    input:
      entries_count: 1000
    expected:
      save_load_identical: true

#!/bin/bash

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VIBEE GENERATED CODE TESTER (PARALLEL)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²ÑÐµÑ… .zig Ñ„Ð°Ð¹Ð»Ð¾Ð² Ñ GNU parallel
# Ï†Â² + 1/Ï†Â² = 3
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

OUTPUT_DIR="trinity/output"
REPORT_FILE="generated_code_test_report_parallel.txt"
JSON_REPORT="generated_code_test_report_parallel.json"

# ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð² (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ = ÐºÐ¾Ð»-Ð²Ð¾ ÑÐ´ÐµÑ€)
PARALLEL_JOBS=${1:-$(nproc)}
if [ -z "$PARALLEL_JOBS" ] || [ "$PARALLEL_JOBS" -lt 1 ]; then
    PARALLEL_JOBS=4
fi

# Ð¦Ð²ÐµÑ‚Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Ð­Ð¼Ð¾Ð´Ð·Ð¸
EMOJI_SUCCESS="âœ…"
EMOJI_ERROR="âŒ"
EMOJI_WARNING="âš ï¸"
EMOJI_INFO="â„¹ï¸"
EMOJI_ROCKET="ðŸš€"
EMOJI_CHART="ðŸ“Š"
EMOJI_TIME="â±ï¸"
EMOJI_FILE="ðŸ“"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ GNU PARALLEL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if ! command -v parallel &> /dev/null; then
    echo -e "${RED}âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: GNU parallel Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½${NC}"
    echo -e "${YELLOW}   Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ:${NC}"
    echo -e "${YELLOW}   brew install parallel  (macOS)${NC}"
    echo -e "${YELLOW}   apt install parallel  (Ubuntu/Debian)${NC}"
    exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð”Ð˜Ð Ð•ÐšÐ¢ÐžÐ Ð˜Ð˜
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if [ ! -d "$OUTPUT_DIR" ]; then
    echo -e "${RED}âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ $OUTPUT_DIR Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°${NC}"
    exit 1
fi

echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}${BOLD}â•‘  ðŸš€ VIBEE GENERATED CODE TESTER (PARALLEL)               â•‘${NC}"
echo -e "${CYAN}â•‘  ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ ${BOLD}$PARALLEL_JOBS${NC}${CYAN} Ð¿Ð¾Ñ‚Ð¾ÐºÐ°Ð¼Ð¸              â•‘${NC}"
echo -e "${CYAN}â•‘  Ï†Â² + 1/Ï†Â² = 3                                               â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ð¡Ð‘ÐžÐ  Ð¤ÐÐ™Ð›ÐžÐ’
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ZIG_FILES=($(ls -1 "$OUTPUT_DIR"/*.zig 2>/dev/null | sort))
TOTAL_FILES=${#ZIG_FILES[@]}

if [ $TOTAL_FILES -eq 0 ]; then
    echo -e "${RED}${EMOJI_ERROR} ${BOLD}ÐžÑˆÐ¸Ð±ÐºÐ°: ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ .zig Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² $OUTPUT_DIR${NC}"
    exit 1
fi

echo -e "${GREEN}${EMOJI_SUCCESS} ${BOLD}ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ $TOTAL_FILES .zig Ñ„Ð°Ð¹Ð»Ð¾Ð²${NC}"
echo -e "${CYAN}${EMOJI_ROCKET} ${BOLD}Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ($PARALLEL_JOBS Ð¿Ð¾Ñ‚Ð¾ÐºÐ¾Ð²)${NC}"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ÐŸÐÐ ÐÐ›Ð›Ð•Ð›Ð¬ÐÐžÐ• Ð¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
TMP_DIR=$(mktemp -d)
trap "rm -rf $TMP_DIR" EXIT

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾
start_time=$(python3 -c "import time; print(int(time.time() * 1000))")

ls -1 "$OUTPUT_DIR"/*.zig 2>/dev/null | parallel \
    --jobs "$PARALLEL_JOBS" \
    --no-notice \
    --bar \
    "zig test {} > \"$TMP_DIR/{/}.result\" 2>&1" || true

end_time=$(python3 -c "import time; print(int(time.time() * 1000))")
total_time_ms=$((end_time - start_time))

echo ""
echo -e "${GREEN}${EMOJI_ROCKET} ${BOLD}Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ñ‹ Ð·Ð° $((total_time_ms / 1000)) ÑÐµÐº${NC}"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ð¡Ð‘ÐžÐ  Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢ÐžÐ’
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PASSED_FILES=0
FAILED_FILES=0
TOTAL_TESTS=0
PASSED_TESTS=0

declare -a PASSED_FILES_LIST=()
declare -a FAILED_FILES_LIST=()
declare -a FAILED_ERRORS=()

for zig_file in "${ZIG_FILES[@]}"; do
    filename=$(basename "$zig_file")
    result_file="$TMP_DIR/$filename.result"

    if [ -f "$result_file" ]; then
        result=$(cat "$result_file")

        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð° ÑƒÑÐ¿ÐµÑ… - Ð¸Ñ‰ÐµÐ¼ "All X tests passed"
        if echo "$result" | grep -q "All [0-9]\+ tests passed"; then
            PASSED_FILES=$((PASSED_FILES + 1))
            PASSED_FILES_LIST+=("$filename")

            # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚ÐµÑÑ‚Ð¾Ð²
            test_count=$(echo "$result" | grep -oE "All [0-9]+ tests passed" | grep -oE "[0-9]+")
            TOTAL_TESTS=$((TOTAL_TESTS + test_count))
            PASSED_TESTS=$((PASSED_TESTS + test_count))
        else
            FAILED_FILES=$((FAILED_FILES + 1))
            FAILED_FILES_LIST+=("$filename")

            # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ - Ð±ÐµÑ€Ñ‘Ð¼ Ð¿ÐµÑ€Ð²Ñ‹Ðµ Ð½ÐµÐ¿ÑƒÑÑ‚Ñ‹Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸
            error_line=$(echo "$result" | grep -v "^[[:space:]]*$" | head -3 | tail -1)
            if [ -z "$error_line" ]; then
                error_line="ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°"
            fi
            FAILED_ERRORS+=("$error_line")
        fi
    else
        # Ð¤Ð°Ð¹Ð» Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ = Ð¾ÑˆÐ¸Ð±ÐºÐ°
        FAILED_FILES=$((FAILED_FILES + 1))
        FAILED_FILES_LIST+=("$filename")
        FAILED_ERRORS+=("Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½")
    fi
done

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ð“Ð•ÐÐ•Ð ÐÐ¦Ð˜Ð¯ ÐžÐ¢Ð§ÐÐ¢Ð
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DATE=$(date "+%Y-%m-%d %H:%M:%S")
SUCCESS_RATE=$((PASSED_FILES * 100 / TOTAL_FILES))
FAILURE_RATE=$((FAILED_FILES * 100 / TOTAL_FILES))
FAILED_TESTS=$((TOTAL_TESTS - PASSED_TESTS))
TOTAL_TIME_S=$((total_time_ms / 1000))
AVG_TIME_MS=$((total_time_ms / TOTAL_FILES))

# ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð°
if [ $SUCCESS_RATE -eq 100 ]; then
    QUALITY="âœ“ ÐžÐ¢Ð›Ð˜Ð§ÐÐž (Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÑŽÑ‚ Ð²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ð¹ ÐºÐ¾Ð´)"
elif [ $SUCCESS_RATE -ge 90 ]; then
    QUALITY="â–² Ð¥ÐžÐ ÐžÐ¨Ðž (Ð±Ð¾Ð»ÑŒÑˆÐ¸Ð½ÑÑ‚Ð²Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð²Ð°Ð»Ð¸Ð´Ð½Ñ‹)"
elif [ $SUCCESS_RATE -ge 70 ]; then
    QUALITY="â—‹ Ð£Ð”ÐžÐ’Ð›Ð•Ð¢Ð’ÐžÐ Ð˜Ð¢Ð•Ð›Ð¬ÐÐž (Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð¼ÐµÑŽÑ‚ Ð¾ÑˆÐ¸Ð±ÐºÐ¸)"
else
    QUALITY="â–¼ ÐŸÐ›ÐžÐ¥Ðž (Ð¼Ð½Ð¾Ð³Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÑŽÑ‚ ÑÐ»Ð¾Ð¼Ð°Ð½Ð½Ñ‹Ð¹ ÐºÐ¾Ð´)"
fi

# Ð¢ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚
cat > "$REPORT_FILE" << EOF
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    VIBEE GENERATED CODE TEST REPORT                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Date: $DATE                                                     â•‘
â•‘  Parallel Jobs: $PARALLEL_JOBS                                                â•‘
â•‘  Ï†Â² + 1/Ï†Â² = 3                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ÐžÐ‘Ð©Ð˜Ð• ÐœÐ•Ð¢Ð Ð˜ÐšÐ˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ð’ÑÐµÐ³Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²:             $TOTAL_FILES
Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ñ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾:   $PASSED_FILES ($SUCCESS_RATE%)
ÐÐµÑƒÐ´Ð°Ñ‡Ð½Ð¾:                  $FAILED_FILES ($FAILURE_RATE%)

Ð’ÑÐµÐ³Ð¾ Ñ‚ÐµÑÑ‚Ð¾Ð²:             $TOTAL_TESTS
ÐŸÑ€Ð¾ÑˆÐ»Ð¾:                   $PASSED_TESTS
ÐÐµ Ð¿Ñ€Ð¾ÑˆÐ»Ð¾:                $FAILED_TESTS

ÐžÐ±Ñ‰ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ:              ${TOTAL_TIME_S} ÑÐµÐº
Ð¡Ñ€ÐµÐ´Ð½ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ Ð½Ð° Ñ„Ð°Ð¹Ð»:    ${AVG_TIME_MS} Ð¼Ñ
ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¿Ð¾Ñ‚Ð¾ÐºÐ¾Ð²:     $PARALLEL_JOBS

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ð£Ð¡ÐŸÐ•Ð¨ÐÐž ÐŸÐ ÐžÐ¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐÐ«Ð• Ð¤ÐÐ™Ð›Ð« ($PASSED_FILES)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$(for file in "${PASSED_FILES_LIST[@]}"; do echo "  âœ“ $file"; done)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ÐÐ•Ð£Ð”ÐÐ§ÐÐ«Ð• Ð¤ÐÐ™Ð›Ð« ($FAILED_FILES)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$(for i in "${!FAILED_FILES_LIST[@]}"; do
    file="${FAILED_FILES_LIST[$i]}"
    error="${FAILED_ERRORS[$i]}"
    echo "  âœ— $file"
    echo "     ÐžÑˆÐ¸Ð±ÐºÐ°: $error"
done)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ð Ð•Ð—Ð®ÐœÐ•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ¾Ð´Ð°: $QUALITY

EOF

# JSON Ð¾Ñ‚Ñ‡Ñ‘Ñ‚
cat > "$JSON_REPORT" << EOF
{
  "date": "$DATE",
  "parallel_jobs": $PARALLEL_JOBS,
  "summary": {
    "total_files": $TOTAL_FILES,
    "passed_files": $PASSED_FILES,
    "failed_files": $FAILED_FILES,
    "success_rate": $SUCCESS_RATE,
    "failure_rate": $FAILURE_RATE
  },
  "tests": {
    "total_tests": $TOTAL_TESTS,
    "passed_tests": $PASSED_TESTS,
    "failed_tests": $FAILED_TESTS
  },
  "performance": {
    "total_time_ms": $total_time_ms,
    "total_time_s": $TOTAL_TIME_S,
    "avg_time_per_file_ms": $AVG_TIME_MS
  },
  "quality": "$QUALITY",
  "passed_files": [
$(for file in "${PASSED_FILES_LIST[@]}"; do echo "    \"$file\","; done | head -n -1)
  ],
  "failed_files": [
$(for i in "${!FAILED_FILES_LIST[@]}"; do
    file="${FAILED_FILES_LIST[$i]}"
    error="${FAILED_ERRORS[$i]}"
    error_json=$(echo "$error" | sed 's/"/\\"/g' | sed 's/\\\\/\\/g')
    echo "    {\"file\": \"$file\", \"error\": \"$error_json\"},"
done | head -n -1)
  ]
}
EOF

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ð’Ð«Ð’ÐžÐ” Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢ÐžÐ’
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo ""
echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}${BOLD}â•‘           ðŸ“Š Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢Ð« Ð¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð¯                            â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Progress bar
if [ $SUCCESS_RATE -eq 100 ]; then
    BAR_COLOR="${GREEN}"
elif [ $SUCCESS_RATE -ge 90 ]; then
    BAR_COLOR="${YELLOW}"
else
    BAR_COLOR="${RED}"
fi

FILLED=$((SUCCESS_RATE / 5))
EMPTY=$((20 - FILLED))
BAR="[${BAR_COLOR}"
for ((i=0; i<FILLED; i++)); do BAR+="â–ˆ"; done
for ((i=0; i<EMPTY; i++)); do BAR+="â–‘"; done
BAR+="${NC}]"

echo -e "${BOLD}${CYAN}ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ:${NC} $BAR ${SUCCESS_RATE}%"
echo ""

# ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ñ ÑÐ¼Ð¾Ð´Ð·Ð¸
echo -e "${MAGENTA}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo -e "${MAGENTA}${BOLD}â”‚  ðŸ“ Ð¤ÐÐ™Ð›Ð«                                                  â”‚${NC}"
echo -e "${MAGENTA}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${NC}"
echo -e "${MAGENTA}â”‚  Ð’ÑÐµÐ³Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²:${NC}        ${BOLD}${BLUE}$TOTAL_FILES${NC}"
echo -e "${MAGENTA}â”‚  Ð£ÑÐ¿ÐµÑˆÐ½Ð¾:${NC}             ${BOLD}${GREEN}$PASSED_FILES${NC} ${EMOJI_SUCCESS}"
echo -e "${MAGENTA}â”‚  ÐÐµÑƒÐ´Ð°Ñ‡Ð½Ð¾:${NC}            ${BOLD}${RED}$FAILED_FILES${NC} ${EMOJI_ERROR}"
echo -e "${MAGENTA}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo ""

echo -e "${MAGENTA}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo -e "${MAGENTA}${BOLD}â”‚  ðŸ§ª Ð¢Ð•Ð¡Ð¢Ð«                                                  â”‚${NC}"
echo -e "${MAGENTA}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${NC}"
echo -e "${MAGENTA}â”‚  Ð’ÑÐµÐ³Ð¾ Ñ‚ÐµÑÑ‚Ð¾Ð²:${NC}        ${BOLD}${BLUE}$TOTAL_TESTS${NC}"
echo -e "${MAGENTA}â”‚  ÐŸÑ€Ð¾ÑˆÐ»Ð¾:${NC}               ${BOLD}${GREEN}$PASSED_TESTS${NC} ${EMOJI_SUCCESS}"
echo -e "${MAGENTA}â”‚  ÐÐµ Ð¿Ñ€Ð¾ÑˆÐ»Ð¾:${NC}            ${BOLD}${RED}$FAILED_TESTS${NC} ${EMOJI_ERROR}"
echo -e "${MAGENTA}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo ""

echo -e "${MAGENTA}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo -e "${MAGENTA}${BOLD}â”‚  â±ï¸  ÐŸÐ ÐžÐ˜Ð—Ð’ÐžÐ”Ð˜Ð¢Ð•Ð›Ð¬ÐÐžÐ¡Ð¢Ð¬                                      â”‚${NC}"
echo -e "${MAGENTA}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${NC}"
echo -e "${MAGENTA}â”‚  ÐžÐ±Ñ‰ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ:${NC}          ${BOLD}${CYAN}${TOTAL_TIME_S} ÑÐµÐº${NC} ${EMOJI_TIME}"
echo -e "${MAGENTA}â”‚  Ð¡Ñ€ÐµÐ´Ð½ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ/Ñ„Ð°Ð¹Ð»:${NC}   ${BOLD}${CYAN}${AVG_TIME_MS} Ð¼Ñ${NC}"
echo -e "${MAGENTA}â”‚  ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¿Ð¾Ñ‚Ð¾ÐºÐ¾Ð²:${NC}  ${BOLD}${YELLOW}$PARALLEL_JOBS${NC} ðŸš€"
echo -e "${MAGENTA}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo ""

# ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ Ñ†Ð²ÐµÑ‚Ð¾Ð²Ð¾Ð¹ ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²ÐºÐ¾Ð¹
if [ $SUCCESS_RATE -eq 100 ]; then
    echo -e "${BOLD}${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${GREEN}â•‘  ðŸŽ‰ ÐžÐ¢Ð›Ð˜Ð§ÐÐž! Ð’ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÑŽÑ‚ Ð²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ð¹ ÐºÐ¾Ð´!           â•‘${NC}"
    echo -e "${BOLD}${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
elif [ $SUCCESS_RATE -ge 90 ]; then
    echo -e "${BOLD}${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${YELLOW}â•‘  ðŸ‘ Ð¥ÐžÐ ÐžÐ¨Ðž! Ð‘Ð¾Ð»ÑŒÑˆÐ¸Ð½ÑÑ‚Ð²Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð²Ð°Ð»Ð¸Ð´Ð½Ñ‹                     â•‘${NC}"
    echo -e "${BOLD}${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
elif [ $SUCCESS_RATE -ge 70 ]; then
    echo -e "${BOLD}${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${RED}â•‘  âš ï¸  Ð£Ð”ÐžÐ’Ð›Ð•Ð¢Ð’ÐžÐ Ð˜Ð¢Ð•Ð›Ð¬ÐÐž - ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð¼ÐµÑŽÑ‚ Ð¾ÑˆÐ¸Ð±ÐºÐ¸        â•‘${NC}"
    echo -e "${BOLD}${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
else
    echo -e "${BOLD}${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${RED}â•‘  âŒ ÐŸÐ›ÐžÐ¥Ðž - ÐœÐ½Ð¾Ð³Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÑŽÑ‚ ÑÐ»Ð¾Ð¼Ð°Ð½Ð½Ñ‹Ð¹ ÐºÐ¾Ð´           â•‘${NC}"
    echo -e "${BOLD}${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
fi

echo ""

if [ $FAILED_FILES -gt 0 ]; then
    echo -e "${BOLD}${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BOLD}${RED}âŒ ÐÐ•Ð£Ð”ÐÐ§ÐÐ«Ð• Ð¤ÐÐ™Ð›Ð« ($FAILED_FILES)${NC}"
    echo -e "${BOLD}${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    for i in "${!FAILED_FILES_LIST[@]}"; do
        file="${FAILED_FILES_LIST[$i]}"
        error="${FAILED_ERRORS[$i]}"
        echo -e "  ${RED}${EMOJI_ERROR} ${BOLD}${file}${NC}"
        echo -e "     ${YELLOW}â–¸ ÐžÑˆÐ¸Ð±ÐºÐ°:${NC} ${error}"
        echo ""
    done
fi

echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}${EMOJI_SUCCESS} ${BOLD}ÐžÑ‚Ñ‡Ñ‘Ñ‚Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹:${NC}"
echo -e "${CYAN}  ðŸ“„ $REPORT_FILE${NC}"
echo -e "${CYAN}  ðŸ“Š $JSON_REPORT${NC}"
echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Ð’Ñ‹Ñ…Ð¾Ð´ Ñ ÐºÐ¾Ð´Ð¾Ð¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸, ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
if [ $FAILED_FILES -gt 0 ]; then
    exit 1
else
    exit 0
fi
